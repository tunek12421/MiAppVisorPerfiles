<ion-header>
  <ion-toolbar color="primary">
    <ion-title>{{ profile ? 'Editar Perfil' : 'Nuevo Perfil' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Avatar Preview -->
  <div class="avatar-section">
    <ion-avatar class="large-avatar">
      <img [src]="formData.avatar || 'https://ionicframework.com/docs/img/demos/avatar.svg'" />
    </ion-avatar>
    <ion-button fill="clear" size="small" (click)="selectAvatar()">
      <ion-icon name="camera" slot="start"></ion-icon>
      Cambiar foto
    </ion-button>
  </div>

  <ion-list>
    <!-- Nombre -->
    <ion-item [color]="formData.name && !isNameValid ? 'danger' : ''">
      <ion-label position="stacked">
        <ion-text color="primary">
          <h2>Nombre completo *</h2>
        </ion-text>
      </ion-label>
      <ion-input 
        [(ngModel)]="formData.name" 
        placeholder="Ej: Juan Pérez"
        [clearInput]="true">
      </ion-input>
      <ion-icon 
        *ngIf="formData.name && isNameValid" 
        name="checkmark-circle" 
        slot="end" 
        color="success">
      </ion-icon>
      <ion-icon 
        *ngIf="formData.name && !isNameValid" 
        name="close-circle" 
        slot="end" 
        color="danger">
      </ion-icon>
    </ion-item>
    <ion-note *ngIf="nameError" color="danger" class="error-message">
      <ion-icon name="alert-circle" class="error-icon"></ion-icon>
      {{ nameError }}
    </ion-note>

    <!-- Email -->
    <ion-item [color]="formData.email && !isEmailValid ? 'danger' : ''">
      <ion-label position="stacked">
        <ion-text color="primary">
          <h2>Correo electrónico *</h2>
        </ion-text>
      </ion-label>
      <ion-input 
        [(ngModel)]="formData.email" 
        type="email"
        placeholder="correo@empresa.com"
        [clearInput]="true">
      </ion-input>
      <ion-icon 
        *ngIf="formData.email && isEmailValid" 
        name="checkmark-circle" 
        slot="end" 
        color="success">
      </ion-icon>
      <ion-icon 
        *ngIf="formData.email && !isEmailValid" 
        name="close-circle" 
        slot="end" 
        color="danger">
      </ion-icon>
    </ion-item>
    <ion-note *ngIf="emailError" color="danger" class="error-message">
      <ion-icon name="alert-circle" class="error-icon"></ion-icon>
      {{ emailError }}
    </ion-note>

    <!-- Teléfono -->
    <ion-item [color]="formData.phone && !isPhoneValid ? 'danger' : ''">
      <ion-label position="stacked">
        <ion-text color="primary">
          <h2>Teléfono</h2>
        </ion-text>
      </ion-label>
      <ion-input 
        [(ngModel)]="formData.phone" 
        type="tel"
        placeholder="+34 600 123 456"
        [clearInput]="true">
      </ion-input>
      <ion-icon 
        *ngIf="formData.phone && isPhoneValid" 
        name="checkmark-circle" 
        slot="end" 
        color="success">
      </ion-icon>
      <ion-icon 
        *ngIf="formData.phone && !isPhoneValid" 
        name="close-circle" 
        slot="end" 
        color="danger">
      </ion-icon>
    </ion-item>
    <ion-note *ngIf="phoneError" color="danger" class="error-message">
      <ion-icon name="alert-circle" class="error-icon"></ion-icon>
      {{ phoneError }}
    </ion-note>

    <!-- CARGO - Selector Interactivo con Búsqueda -->
    <ion-item button (click)="openRoleSelector()" [color]="!formData.role ? 'light' : ''">
      <ion-label>
        <ion-text color="primary">
          <h2>Cargo *</h2>
        </ion-text>
        <p *ngIf="!formData.role" class="placeholder-text">Selecciona un cargo</p>
        <h3 *ngIf="formData.role">{{ formData.role }}</h3>
      </ion-label>
      <ion-icon name="briefcase-outline" slot="start" color="medium"></ion-icon>
      <ion-icon name="chevron-forward" slot="end" color="medium"></ion-icon>
      <ion-icon 
        *ngIf="formData.role" 
        name="checkmark-circle" 
        slot="end" 
        color="success" 
        style="margin-left: 5px;">
      </ion-icon>
    </ion-item>

    <!-- DEPARTAMENTO - Selector Visual con Chips -->
    <ion-item>
      <ion-label position="stacked">
        <ion-text color="primary">
          <h2>Departamento *</h2>
        </ion-text>
      </ion-label>
    </ion-item>
    
    <div class="department-chips">
      <ion-chip 
        *ngFor="let dept of availableDepartments"
        [color]="formData.department === dept ? 'primary' : 'medium'"
        [outline]="formData.department !== dept"
        (click)="selectDepartment(dept)">
        <ion-icon [name]="getDepartmentIcon(dept)"></ion-icon>
        <ion-label>{{ dept }}</ion-label>
        <ion-icon *ngIf="formData.department === dept" name="checkmark-circle"></ion-icon>
      </ion-chip>
    </div>

    <!-- Estado -->
    <ion-item>
      <ion-label>
        <ion-text color="primary">
          <h2>Estado del perfil</h2>
        </ion-text>
      </ion-label>
      <ion-toggle 
        [(ngModel)]="isActive" 
        color="success">
      </ion-toggle>
      <ion-note slot="end">{{ isActive ? 'Activo' : 'Inactivo' }}</ion-note>
    </ion-item>
  </ion-list>

  <!-- Botones de acción -->
  <div class="action-buttons">
    <ion-button 
      expand="block" 
      color="medium" 
      fill="outline"
      (click)="dismiss()">
      Cancelar
    </ion-button>
    <ion-button 
      expand="block" 
      color="primary"
      [disabled]="!isFormValid()"
      (click)="save()">
      <ion-icon name="save" slot="start"></ion-icon>
      {{ profile ? 'Actualizar' : 'Guardar' }}
    </ion-button>
  </div>
</ion-content>